//     Spark.js
//     http://www.meteor.com/
//     Copyright (C) 2011--2012 Meteor Development Group
//     Meteor/Spark may be freely distributed under the MIT license.

//     Underscore.js 1.4.2
//     http://underscorejs.org
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.
Meteor={};(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,unshift=ArrayProto.unshift,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root["_"]=_}_.VERSION="1.4.2";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{for(var key in obj){if(_.has(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker)return}}}};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results[results.length]=iterator.call(context,value,index,list)});return results};_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError("Reduce of empty array with no initial value");return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return arguments.length>2?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError("Reduce of empty array with no initial value");return memo};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value});return results};_.reject=function(obj,iterator,context){var results=[];if(obj==null)return results;each(obj,function(value,index,list){if(!iterator.call(context,value,index,list))results[results.length]=value});return results};_.every=_.all=function(obj,iterator,context){iterator||(iterator=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker});return!!result};var any=_.some=_.any=function(obj,iterator,context){iterator||(iterator=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result||(result=iterator.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){var found=false;if(obj==null)return found;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;found=any(obj,function(value){return value===target});return found};_.invoke=function(obj,method){var args=slice.call(arguments,2);return _.map(obj,function(value){return(_.isFunction(method)?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,function(value){return value[key]})};_.where=function(obj,attrs){if(_.isEmpty(attrs))return[];return _.filter(obj,function(value){for(var key in attrs){if(attrs[key]!==value[key])return false}return true})};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return-Infinity;var result={computed:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>=result.computed&&(result={value:value,computed:computed})});return result.value};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return Infinity;var result={computed:Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed})});return result.value};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};var lookupIterator=function(value){return _.isFunction(value)?value:function(obj){return obj[value]}};_.sortBy=function(obj,value,context){var iterator=lookupIterator(value);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index<right.index?-1:1}),"value")};var group=function(obj,value,context,behavior){var result={};var iterator=lookupIterator(value);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)});return result};_.groupBy=function(obj,value,context){return group(obj,value,context,function(result,key,value){(_.has(result,key)?result[key]:result[key]=[]).push(value)})};_.countBy=function(obj,value,context){return group(obj,value,context,function(result,key,value){if(!_.has(result,key))result[key]=0;result[key]++})};_.sortedIndex=function(array,obj,iterator,context){iterator=iterator==null?_.identity:lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(obj.length===+obj.length)return slice.call(obj);return _.values(obj)};_.size=function(obj){return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){return n!=null&&!guard?slice.call(array,0,n):array[0]};_.initial=function(array,n,guard){return slice.call(array,0,array.length-(n==null||guard?1:n))};_.last=function(array,n,guard){if(n!=null&&!guard){return slice.call(array,Math.max(array.length-n,0))}else{return array[array.length-1]}};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,function(value){return!!value})};var flatten=function(input,shallow,output){each(input,function(value){if(_.isArray(value)){shallow?push.apply(output,value):flatten(value,shallow,output)}else{output.push(value)}});return output};_.flatten=function(array,shallow){return flatten(array,shallow,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iterator,context){var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?!index||seen[seen.length-1]!==value:!_.contains(seen,value)){seen.push(value);results.push(array[index])}});return results};_.union=function(){return _.uniq(concat.apply(ArrayProto,arguments))};_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.indexOf(other,item)>=0})})};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var args=slice.call(arguments);var length=_.max(_.pluck(args,"length"));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(args,""+i)}return results};_.object=function(list,values){var result={};for(var i=0,l=list.length;i<l;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,l=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,l+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<l;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item)}var i=hasIndex?from:array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var len=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(len);while(idx<len){range[idx++]=start;start+=step}return range};var ctor=function(){};_.bind=function bind(func,context){var bound,args;if(func.bind===nativeBind&&nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError;args=slice.call(arguments,2);return bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));ctor.prototype=func.prototype;var self=new ctor;var result=func.apply(self,args.concat(slice.call(arguments)));if(Object(result)===result)return result;return self}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length==0)funcs=_.functions(obj);each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait){var context,args,timeout,throttling,more,result;var whenDone=_.debounce(function(){more=throttling=false},wait);return function(){context=this;args=arguments;var later=function(){timeout=null;if(more){result=func.apply(context,args)}whenDone()};if(!timeout)timeout=setTimeout(later,wait);if(throttling){more=true}else{throttling=true;result=func.apply(context,args)}whenDone();return result}};_.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)result=func.apply(context,args)};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)result=func.apply(context,args);return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return function(){var args=[func];push.apply(args,arguments);return wrapper.apply(this,args)}};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){if(times<=0)return func();return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(_.has(obj,key))keys[keys.length]=key;return keys};_.values=function(obj){var values=[];for(var key in obj)if(_.has(obj,key))values.push(obj[key]);return values};_.pairs=function(obj){var pairs=[];for(var key in obj)if(_.has(obj,key))pairs.push([key,obj[key]]);return pairs};_.invert=function(obj){var result={};for(var key in obj)if(_.has(obj,key))result[obj[key]]=key;return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){for(var prop in source){obj[prop]=source[prop]}});return obj};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key]});return copy};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key]}return copy};_.defaults=function(obj){each(slice.call(arguments,1),function(source){for(var prop in source){if(obj[prop]==null)obj[prop]=source[prop]}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,"callee"))}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return _.isNumber(obj)&&isFinite(obj)};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.times=function(n,iterator,context){for(var i=0;i<n;i++)iterator.call(context,i)};_.random=function(min,max){if(max==null){max=min;min=0}return min+(0|Math.random()*(max-min+1))};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return null;var value=object[property];return _.isFunction(value)?value.call(object):value};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=idCounter++;return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return"\\"+escapes[match]});source+=escape?"'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'":interpolate?"'+\n((__t=("+interpolate+"))==null?'':__t)+\n'":evaluate?"';\n"+evaluate+"\n__p+='":"";index=offset+match.length});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};template.source="function("+(settings.variable||"obj")+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);(function(){var suppress=0;Meteor._debug=function(){if(suppress){suppress--;return}if(typeof console!=="undefined"&&typeof console.log!=="undefined"){if(arguments.length==0){console.log("")}else{if(typeof console.log.apply==="function"){console.log.apply(console,arguments)}else if(typeof Function.prototype.bind==="function"){var log=Function.prototype.bind.call(console.log,console);log.apply(console,arguments)}else{Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments))}}}};Meteor._suppress_log=function(count){suppress+=count}})();(function(){Random={};Random._Alea=function(){function Mash(){var n=4022871197;var mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296}return(n>>>0)*2.3283064365386963e-10};mash.version="Mash 0.9";return mash}return function(args){var s0=0;var s1=0;var s2=0;var c=1;if(args.length==0){args=[+new Date]}var mash=Mash();s0=mash(" ");s1=mash(" ");s2=mash(" ");for(var i=0;i<args.length;i++){s0-=mash(args[i]);if(s0<0){s0+=1}s1-=mash(args[i]);if(s1<0){s1+=1}s2-=mash(args[i]);if(s2<0){s2+=1}}mash=null;var random=function(){var t=2091639*s0+c*2.3283064365386963e-10;s0=s1;s1=s2;return s2=t-(c=t|0)};random.uint32=function(){return random()*4294967296};random.fract53=function(){return random()+(random()*2097152|0)*1.1102230246251565e-16};random.version="Alea 0.9";random.args=args;return random}(Array.prototype.slice.call(arguments))};var height=typeof window!=="undefined"&&window.innerHeight||typeof document!=="undefined"&&document.documentElement&&document.documentElement.clientHeight||typeof document!=="undefined"&&document.body&&document.body.clientHeight||1;var width=typeof window!=="undefined"&&window.innerWidth||typeof document!=="undefined"&&document.documentElement&&document.documentElement.clientWidth||typeof document!=="undefined"&&document.body&&document.body.clientWidth||1;var agent=typeof navigator!=="undefined"&&navigator.userAgent||"";var pid=typeof process!=="undefined"&&process.pid||1;Random.fraction=new Random._Alea([new Date,height,width,agent,pid,Math.random()]);Random.choice=function(arrayOrString){var index=Math.floor(Random.fraction()*arrayOrString.length);if(typeof arrayOrString==="string")return arrayOrString.substr(index,1);else return arrayOrString[index]};var UNMISTAKABLE_CHARS="23456789ABCDEFGHJKLMNPQRSTWXYZabcdefghijkmnopqrstuvwxyz";Random.id=function(){var digits=[];for(var i=0;i<17;i++){digits[i]=Random.choice(UNMISTAKABLE_CHARS)}return digits.join("")};var HEX_DIGITS="0123456789abcdef";Random.hexString=function(digits){var hexDigits=[];for(var i=0;i<digits;++i){hexDigits.push(Random.choice("0123456789abcdef"))}return hexDigits.join("")}})();(function(){var pending_invalidate=[];var next_id=1;var Context=function(){this.id=next_id++;this._callbacks=[];this.invalidated=false};Context.current=null;_.extend(Context.prototype,{run:function(f){var previous=Context.current;Context.current=this;try{return f()}finally{Context.current=previous}},invalidate:function(){if(!this.invalidated){this.invalidated=true;if(!pending_invalidate.length)setTimeout(Meteor.flush,0);pending_invalidate.push(this)}},onInvalidate:function(f){if(this.invalidated)f(this);else this._callbacks.push(f)}});_.extend(Meteor,{flush:function(){while(pending_invalidate.length){var pending=pending_invalidate;pending_invalidate=[];_.each(pending,function(ctx){_.each(ctx._callbacks,function(f){try{f(ctx)}catch(e){Meteor._debug("Exception from Meteor.flush:",e.stack)}});delete ctx._callbacks})}},deps:{Context:Context}})})();(function(){var _ContextSet=function(){this._contextsById={}};_ContextSet.prototype.add=function(ctx){var self=this;if(ctx&&!(ctx.id in self._contextsById)){self._contextsById[ctx.id]=ctx;ctx.onInvalidate(function(){delete self._contextsById[ctx.id]});return true}return false};_ContextSet.prototype.addCurrentContext=function(){var self=this;var context=Meteor.deps.Context.current;if(!context)return false;return self.add(context)};_ContextSet.prototype.invalidateAll=function(){var self=this;for(var id in self._contextsById)self._contextsById[id].invalidate()};_ContextSet.prototype.isEmpty=function(){var self=this;for(var id in self._contextsById)return false;return true};Meteor.deps._ContextSet=_ContextSet;Meteor.autorun=function(f){var ctx;var slain=false;var handle={stop:function(){slain=true;ctx.invalidate()}};var rerun=function(){if(slain)return;ctx=new Meteor.deps.Context;ctx.run(function(){f.call(this,handle)});ctx.onInvalidate(rerun)};rerun();return handle};var atFlushQueue=[];var atFlushContext=null;Meteor._atFlush=function(f){atFlushQueue.push(f);if(!atFlushContext){atFlushContext=new Meteor.deps.Context;atFlushContext.onInvalidate(function(){var f;while(f=atFlushQueue.shift()){try{f()}catch(e){Meteor._debug("Exception from Meteor._atFlush:",e.stack)}}atFlushContext=null});atFlushContext.invalidate()}}})();(function(){var canSetTextProps=function(){var testElem=document.createTextNode("");var exception;try{testElem.test=123}catch(exception){}if(testElem.test!==123)return false;if(document.documentMode)return false;return true}();var wrapEndpoints=function(start,end){if(canSetTextProps){return[start,end]}else{if(start.nodeType===3){var placeholder=document.createComment("IE");start.parentNode.insertBefore(placeholder,start);start=placeholder}if(end.nodeType===3){var placeholder=document.createComment("IE");end.parentNode.insertBefore(placeholder,end.nextSibling);end=placeholder}return[start,end]}};LiveRange=function(tag,start,end,inner){if(start.nodeType===11){end=start.lastChild;start=start.firstChild}else{if(!start.parentNode)throw new Error("LiveRange start and end must have a parent")}end=end||start;this.tag=tag;var endpoints=wrapEndpoints(start,end);start=this._ensureTag(endpoints[0]);end=this._ensureTag(endpoints[1]);var startIndex=findPosition(start[tag][0],true,end,start,inner);var endIndex=findPosition(end[tag][1],false,start,end,inner);this._insertEntries(start,0,startIndex,[this]);this._insertEntries(end,1,endIndex,[this])};var findPosition=function(ranges,findEndNotStart,edge,otherEdge,inner){var index;var initialN=findEndNotStart?edge.parentNode.lastChild:otherEdge;var takeFirst=findEndNotStart?!inner:inner;for(var i=0,n=initialN;i<=ranges.length;i++){var r=ranges[i];var curEdge=r&&(findEndNotStart?r._end:r._start);while(n!==curEdge&&n!==edge){n=n.previousSibling}if(curEdge===edge){index=i;if(takeFirst)break}else if(n===edge){index=i;break}}return index};LiveRange.prototype._ensureTag=function(node){if(!(this.tag in node))node[this.tag]=[[],[]];return node};var canDeleteExpandos=function(){var node=document.createElement("DIV");var exception;var result=false;try{node.test=12;delete node.test;result=true}catch(exception){}return result}();LiveRange._cleanNode=function(tag,node,force){var data=node[tag];if(data&&(!(data[0].length+data[1].length)||force)){if(canDeleteExpandos)delete node[tag];else node.removeAttribute(tag)}};LiveRange.prototype.destroy=function(recursive){var self=this;if(recursive){this.visit(function(isStart,range){if(isStart){range._start=null;range._end=null}},function(isStart,node){if(!isStart){for(var n=node.firstChild;n;n=n.nextSibling){LiveRange._cleanNode(self.tag,n,true)}}});this._removeEntries(this._start,0,this._startIndex);this._removeEntries(this._end,1,0,this._endIndex+1);if(this._start!==this._end){for(var n=this._start.nextSibling;n!==this._end;n=n.nextSibling){LiveRange._cleanNode(self.tag,n,true)}if(this._start[self.tag])this._removeEntries(this._start,1);if(this._end[self.tag])this._removeEntries(this._end,0)}this._start=this._end=null}else{this._removeEntries(this._start,0,this._startIndex,this._startIndex+1);this._removeEntries(this._end,1,this._endIndex,this._endIndex+1);this._start=this._end=null}};LiveRange.prototype.firstNode=function(){return this._start};LiveRange.prototype.lastNode=function(){return this._end};LiveRange.prototype.containerNode=function(){return this._start.parentNode};LiveRange.prototype.visit=function(visitRange,visitNode){visitRange=visitRange||function(){};visitNode=visitNode||function(){};var tag=this.tag;var recurse=function(start,end,startRangeSkip){var startIndex=startRangeSkip||0;var after=end.nextSibling;for(var n=start;n&&n!==after;n=n.nextSibling){var startData=n[tag]&&n[tag][0];if(startData&&startIndex<startData.length){var range=startData[startIndex];var rangeStart=range._start;var rangeEnd=range._end;if(visitRange(true,range)!==false)recurse(rangeStart,rangeEnd,startIndex+1);visitRange(false,range);n=rangeEnd}else{if(visitNode(true,n)!==false&&n.firstChild)recurse(n.firstChild,n.lastChild);visitNode(false,n)}startIndex=0}};recurse(this._start,this._end,this._startIndex+1)};LiveRange.prototype._removeEntries=function(node,startEnd,i,j){var entries=node[this.tag][startEnd];i=i||0;j=j||j===0?j:entries.length;var removed=entries.splice(i,j-i);for(var a=i;a<entries.length;a++){if(startEnd)entries[a]._endIndex=a;else entries[a]._startIndex=a}if(!entries.length){LiveRange._cleanNode(this.tag,node)}return removed};LiveRange.prototype._insertEntries=function(node,startEnd,i,newRanges){var entries=node[this.tag][startEnd];Array.prototype.splice.apply(entries,[i,0].concat(newRanges));for(var a=i;a<entries.length;a++){if(startEnd){entries[a]._end=node;entries[a]._endIndex=a}else{entries[a]._start=node;entries[a]._startIndex=a}}};LiveRange.prototype.replaceContents=function(newFrag){if(!newFrag.firstChild)throw new Error("replaceContents requires non-empty fragment");return this.operate(function(oldStart,oldEnd){oldStart.parentNode.insertBefore(newFrag,oldStart);var retFrag=oldStart.ownerDocument.createDocumentFragment();var walk=oldStart;while(true){var next=walk.nextSibling;retFrag.appendChild(walk);if(walk===oldEnd)break;walk=next;if(!walk)throw new Error("LiveRanges must begin and end on siblings in order")}return retFrag})};LiveRange.prototype.operate=function(func){var oldStart=this._start;var oldEnd=this._end;var outerStarts=this._removeEntries(oldStart,0,0,this._startIndex+1);var outerEnds=this._removeEntries(oldEnd,1,this._endIndex);var containerNode=oldStart.parentNode;var beforeNode=oldStart.previousSibling;var afterNode=oldEnd.nextSibling;var ret=null;ret=func(oldStart,oldEnd);var newStart=beforeNode?beforeNode.nextSibling:containerNode.firstChild;var newEnd=afterNode?afterNode.previousSibling:containerNode.lastChild;if(!newStart||newStart===afterNode){throw new Error("Ranges must contain at least one element")}var newEndpoints=wrapEndpoints(newStart,newEnd);newStart=this._ensureTag(newEndpoints[0]);newEnd=this._ensureTag(newEndpoints[1]);this._insertEntries(newStart,0,0,outerStarts);this._insertEntries(newEnd,1,newEnd[this.tag][1].length,outerEnds);return ret};LiveRange.transplantTag=function(tag,targetNode,sourceNode){if(!sourceNode[tag])return;targetNode[tag]=sourceNode[tag];sourceNode[tag]=null;var starts=targetNode[tag][0];var ends=targetNode[tag][1];for(var i=0;i<starts.length;i++)starts[i]._start=targetNode;for(var i=0;i<ends.length;i++)ends[i]._end=targetNode};LiveRange.transplantRange=function(tgtStart,tgtEnd,srcRange){srcRange._ensureTag(tgtStart);if(tgtEnd!==tgtStart)srcRange._ensureTag(tgtEnd);srcRange._insertEntries(tgtStart,0,0,srcRange._start[srcRange.tag][0].slice(0,srcRange._startIndex+1));srcRange._insertEntries(tgtEnd,1,0,srcRange._end[srcRange.tag][1].slice(srcRange._endIndex))};LiveRange.prototype.insertBefore=function(frag){var fragStart=frag.firstChild;if(!fragStart)return;this._start.parentNode.insertBefore(frag,this._start);this._ensureTag(fragStart);this._insertEntries(fragStart,0,0,this._removeEntries(this._start,0,0,this._startIndex))};LiveRange.prototype.insertAfter=function(frag){var fragEnd=frag.lastChild;if(!fragEnd)return;this._end.parentNode.insertBefore(frag,this._end.nextSibling);this._ensureTag(fragEnd);this._insertEntries(fragEnd,1,fragEnd[this.tag][1].length,this._removeEntries(this._end,1,this._endIndex+1))};LiveRange.prototype.extract=function(){if(this._startIndex>0&&this._start[this.tag][0][this._startIndex-1]._end===this._end){return null}var before=this._start.previousSibling;var after=this._end.nextSibling;var parent=this._start.parentNode;if(this._startIndex>0){this._ensureTag(after);this._insertEntries(after,0,0,this._removeEntries(this._start,0,0,this._startIndex))
}if(this._endIndex<this._end[this.tag][1].length-1){this._ensureTag(before);this._insertEntries(before,1,before[this.tag][1].length,this._removeEntries(this._end,1,this._endIndex+1))}var result=document.createDocumentFragment();for(var n;n=before?before.nextSibling:parent.firstChild,n&&n!==after;)result.appendChild(n);return result};LiveRange.prototype.findParent=function(withSameContainer){var result=enclosingRangeSearch(this.tag,this._end,this._endIndex);if(result)return result;if(withSameContainer)return null;return LiveRange.findRange(this.tag,this.containerNode())};LiveRange.findRange=function(tag,node){var result=enclosingRangeSearch(tag,node);if(result)return result;if(!node.parentNode)return null;return LiveRange.findRange(tag,node.parentNode)};var enclosingRangeSearch=function(tag,end,endIndex){if(typeof endIndex==="undefined")endIndex=-1;if(end[tag]&&endIndex+1<end[tag][1].length){return end[tag][1][endIndex+1]}var node=end.nextSibling;while(node){var endIndex=0;var startData=node[tag]&&node[tag][0];if(startData&&startData.length){var r=startData[0];node=r._end;endIndex=r._endIndex+1}if(node[tag]&&endIndex<node[tag][1].length)return node[tag][1][endIndex];node=node.nextSibling}return null}})();(function(){var listeners=[];var returnFalse=function(){return false};var returnTrue=function(){return true};var normalizeEvent=function(event){var originalStopPropagation=event.stopPropagation;var originalPreventDefault=event.preventDefault;event.isPropagationStopped=returnFalse;event.isImmediatePropagationStopped=returnFalse;event.isDefaultPrevented=returnFalse;event.stopPropagation=function(){event.isPropagationStopped=returnTrue;if(originalStopPropagation)originalStopPropagation.call(event);else event.cancelBubble=true};event.preventDefault=function(){event.isDefaultPrevented=returnTrue;if(originalPreventDefault)originalPreventDefault.call(event);else event.returnValue=false};event.stopImmediatePropagation=function(){event.stopPropagation();event.isImmediatePropagationStopped=returnTrue};var type=event.type;if(event.metaKey===undefined)event.metaKey=event.ctrlKey;if(/^key/.test(type)){if(event.which==null)event.which=event.charCode!=null?event.charCode:event.keyCode}else if(/^(?:mouse|contextmenu)|click/.test(type)){if(!event.relatedTarget&&event.fromElement)event.relatedTarget=event.fromElement===event.target?event.toElement:event.fromElement;if(!event.which&&event.button!==undefined){var button=event.button;event.which=button&1?1:button&2?3:button&4?2:0}}return event};var deliver=function(event){event=normalizeEvent(event);_.each(listeners,function(listener){if(listener.types[event.type]){if(!(listener._checkIECompliance&&!event.currentTarget["_uevents_test_eventtype_"+event.type]))listener.handler.call(null,event)}})};var impl;var getImpl=function(){if(!impl)impl=document.addEventListener?new UniversalEventListener._impl.w3c(deliver):new UniversalEventListener._impl.ie(deliver);return impl};var typeCounts={};UniversalEventListener=function(handler,_checkIECompliance){this.handler=handler;this.types={};this.impl=getImpl();this._checkIECompliance=_checkIECompliance;listeners.push(this)};_.extend(UniversalEventListener.prototype,{addType:function(type){if(!this.types[type]){this.types[type]=true;typeCounts[type]=(typeCounts[type]||0)+1;if(typeCounts[type]===1)this.impl.addType(type)}},removeType:function(type){if(this.types[type]){delete this.types[type];typeCounts[type]--;if(!typeCounts[type])this.impl.removeType(type)}},installHandler:function(node,type){if(node.nodeType!==1)return;this.impl.installHandler(node,type);if(this._checkIECompliance){node["_uevents_test_eventtype_"+type]=node;if(node.firstChild){_.each(node.getElementsByTagName("*"),function(x){x["_uevents_test_eventtype_"+type]=x})}}},destroy:function(){var self=this;listeners=_.without(listeners,self);_.each(_.keys(self.types),function(type){self.removeType(type)})}})})();UniversalEventListener._impl=UniversalEventListener._impl||{};UniversalEventListener._impl.ie=function(deliver){var self=this;this.deliver=deliver;this.curriedHandler=function(){self.handler.call(this,self)};document.attachEvent("ondatasetcomplete",function(){var evt=window.event;var target=evt&&evt.srcElement;if(evt.synthetic&&target&&target.nodeName==="FORM"&&evt.returnValue!==false)target.submit()})};_.extend(UniversalEventListener._impl.ie.prototype,{addType:function(type){},removeType:function(type){},installHandler:function(node,type){var prop="on"+type;if(node.nodeType===1){this._install(node,prop);var descendents=node.getElementsByTagName("*");for(var i=0,N=descendents.length;i<N;i++)this._install(descendents[i],prop)}},_install:function(node,prop){var props=[prop];if(prop==="onfocus")props.push("onfocusin");else if(prop==="onblur")props.push("onfocusout");else if(prop==="onchange"){if(node.nodeName==="INPUT"&&(node.type==="checkbox"||node.type==="radio"))props=["onpropertychange"];props.push("oncellchange")}else if(prop==="onsubmit")props.push(node,"ondatasetcomplete");for(var i=0;i<props.length;i++)node[props[i]]=this.curriedHandler},handler:function(self){var sendEvent=function(ontype,target){var e=document.createEventObject();e.synthetic=true;target.fireEvent(ontype,e);return e.returnValue};var event=window.event;var type=event.type;var target=event.srcElement||document;event.target=target;if(this.nodeType!==1)return;event.currentTarget=this;var curNode=this;if(curNode===target&&!event.synthetic){if(type==="focusin")sendEvent("onfocus",curNode);else if(type==="focusout")sendEvent("onblur",curNode);else if(type==="change")sendEvent("oncellchange",curNode);else if(type==="propertychange"){if(event.propertyName==="checked")sendEvent("oncellchange",curNode)}else if(type==="submit"){sendEvent("ondatasetcomplete",curNode)}}if((type==="focus"||event.type==="blur"||event.type==="change"||event.type==="submit")&&!event.synthetic){if(event.type==="submit")event.returnValue=false;return}if(type==="cellchange"&&event.synthetic){type=event.type="change"}if(type==="datasetcomplete"&&event.synthetic){type=event.type="submit"}self.deliver(event)}});(function(){var SIMULATE_NEITHER=0;var SIMULATE_FOCUS_BLUR=1;var SIMULATE_FOCUSIN_FOCUSOUT=2;UniversalEventListener._impl=UniversalEventListener._impl||{};UniversalEventListener._impl.w3c=function(deliver){this.deliver=deliver;this.typeCounts={};this.boundHandler=_.bind(this.handler,this);this.boundCapturer=_.bind(this.capturer,this);this.focusBlurMode="onfocusin"in document.createElement("DIV")?SIMULATE_NEITHER:SIMULATE_FOCUSIN_FOCUSOUT;this.simulateMouseEnterLeave=!window.opera};_.extend(UniversalEventListener._impl.w3c.prototype,{addType:function(eventType){this._listen(this._expandEventType(eventType))},removeType:function(type){this._unlisten(this._expandEventType(type))},installHandler:function(node,type){},_expandEventType:function(type){var ret=[type];if(this.focusBlurMode===SIMULATE_FOCUS_BLUR){if(type==="focus")ret.push("focusin");else if(type==="blur")ret.push("focusout")}else if(this.focusBlurMode===SIMULATE_FOCUSIN_FOCUSOUT){if(type==="focusin")ret.push("focus");else if(type==="focusout")ret.push("blur")}if(this.simulateMouseEnterLeave){if(type==="mouseenter")ret.push("mouseover");else if(type==="mouseleave")ret.push("mouseout")}return ret},_listen:function(types){var self=this;_.each(types,function(type){if((self.typeCounts[type]=(self.typeCounts[type]||0)+1)===1)document.addEventListener(type,self.boundCapturer,true)})},_unlisten:function(types){var self=this;_.each(types,function(type){if(!--self.typeCounts[type]){document.removeEventListener(type,self.boundCapturer,true)}})},capturer:function(event){if(event.target.nodeType===3)event.target=event.target.parentNode;var type=event.type;var bubbles=event.bubbles;var target=event.target;target.addEventListener(type,this.boundHandler,false);var ancestors;if(bubbles){ancestors=[];for(var n=target.parentNode;n;n=n.parentNode){n.addEventListener(type,this.boundHandler,false);ancestors.push(n)}}setTimeout(function(){target.removeEventListener(type,this.boundHandler,false);if(bubbles){_.each(ancestors,function(n){n.removeEventListener(type,this.boundHandler,false)})}},0)},handler:function(event){var sendUIEvent=function(type,target,bubbles,cancelable,detail){var evt=document.createEvent("UIEvents");evt.initUIEvent(type,bubbles,cancelable,window,detail);evt.synthetic=true;target.dispatchEvent(evt)};if(event.currentTarget===event.target){if(this.focusBlurMode===SIMULATE_FOCUS_BLUR){if(event.type==="focusin")sendUIEvent("focus",event.target,false);else if(event.type==="focusout")sendUIEvent("blur",event.target,false)}else if(this.focusBlurMode===SIMULATE_FOCUSIN_FOCUSOUT){if(event.type==="focus")sendUIEvent("focusin",event.target,true);else if(event.type==="blur")sendUIEvent("focusout",event.target,true)}}if(this.focusBlurMode===SIMULATE_FOCUS_BLUR){if(event.type==="focus"||event.type==="blur"){if(!event.synthetic)return}}else if(this.focusBlurMode===SIMULATE_FOCUSIN_FOCUSOUT){if(event.type==="focusin"||event.type==="focusout"){if(!event.synthetic)return}}if(this.simulateMouseEnterLeave){if(event.type==="mouseenter"||event.type==="mouseleave"){if(!event.synthetic)return}}this.deliver(event);if(this.simulateMouseEnterLeave&&(!event.relatedTarget||event.currentTarget!==event.relatedTarget&&!DomUtils.elementContains(event.currentTarget,event.relatedTarget))){if(event.type==="mouseover"){sendUIEvent("mouseenter",event.currentTarget,false)}else if(event.type==="mouseout"){sendUIEvent("mouseleave",event.currentTarget,false)}}}})})();DomUtils={};(function(){var qsaFindAllBySelector=function(selector,contextNode){if(!document.querySelectorAll)throw new Error("This browser doesn't support querySelectorAll.");var ancestor=contextNode;return withElementId(contextNode,"DomUtils_findAllBySelector_scope",function(idSelector){var doctoredSelector=_.map(selector.split(","),function(selec){return idSelector+" "+selec}).join(",");return ancestor.querySelectorAll(doctoredSelector)})};var findAllBySelector=window.Sizzle||window.jQuery&&window.jQuery.find||qsaFindAllBySelector;var testDiv=document.createElement("div");testDiv.innerHTML="   <link/><table></table><select><!----></select>";var testSelectDiv=document.createElement("div");testSelectDiv.innerHTML="<select><option selected>Foo</option></select>";testSelectDiv.firstChild.setAttribute("name","myname");var quirks={leadingWhitespaceKilled:testDiv.firstChild.nodeType!==3,tbodyInsertion:testDiv.getElementsByTagName("tbody").length>0,tagsLost:testDiv.getElementsByTagName("link").length===0,commentsLost:!testDiv.getElementsByTagName("select")[0].firstChild,selectValueMustBeFromAttribute:testSelectDiv.firstChild.value!=="Foo",mustSetNameInCreateElement:testSelectDiv.firstChild.outerHTML&&testSelectDiv.firstChild.outerHTML.indexOf("myname")===-1};var wrapMap={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]};_.extend(wrapMap,{optgroup:wrapMap.option,tbody:wrapMap.thead,tfoot:wrapMap.thead,colgroup:wrapMap.thead,caption:wrapMap.thead,th:wrapMap.td});if(quirks.tagsLost){wrapMap._default=[1,"div<div>","</div>"]}var rleadingWhitespace=/^\s+/,rxhtmlTag=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,rtagName=/<([\w:]+)/,rtbody=/<tbody/i,rhtml=/<|&#?\w+;/,rnoInnerhtml=/<(?:script|style)/i;DomUtils.htmlToFragment=function(html){var doc=document;var frag=doc.createDocumentFragment();if(!html.length){}else if(!rhtml.test(html)){frag.appendChild(doc.createTextNode(html))}else{html=html.replace(rxhtmlTag,"<$1></$2>");var firstTagMatch=rtagName.exec(html);var firstTag=firstTagMatch?firstTagMatch[1].toLowerCase():"";var wrapData=wrapMap[firstTag]||wrapMap._default;var fullHtml=wrapData[1]+html+wrapData[2];if(quirks.commentsLost){fullHtml=fullHtml.replace(/<\s*(select|option)\b/gi,'<ins domutilsrealtagname="$1"');fullHtml=fullHtml.replace(/<\/\s*(select|option)\b/gi,"</ins")}var container=doc.createElement("div");container.innerHTML=fullHtml;var unwraps=wrapData[0];while(unwraps--){container=container.lastChild}if(quirks.tbodyInsertion&&!rtbody.test(html)){var tbodies=container.getElementsByTagName("tbody");_.each(tbodies,function(n){if(!n.firstChild){n.parentNode.removeChild(n)}})}if(quirks.leadingWhitespaceKilled){var wsMatch=rleadingWhitespace.exec(html);if(wsMatch){container.insertBefore(doc.createTextNode(wsMatch[0]),container.firstChild)}}if(quirks.commentsLost){var fakeTags=[];_.each(container.getElementsByTagName("ins"),function(ins){if(ins.getAttribute("domutilsrealtagname")){fakeTags.push(ins)}});_.each(fakeTags,function(fakeTag){var tagName=fakeTag.getAttribute("domutilsrealtagname");if(quirks.mustSetNameInCreateElement&&fakeTag.getAttribute("name")){tagName="<"+tagName+" name='"+_.escape(fakeTag.getAttribute("name"))+"'/>"}var realTag=document.createElement(tagName);fakeTag.removeAttribute("domutilsrealtagname");var fakeAttrs=fakeTag.attributes;for(var i=0;i<fakeAttrs.length;++i){var fakeAttr=fakeAttrs.item(i);if(fakeAttr.specified){var name=fakeAttr.name.toLowerCase();var value=String(fakeAttr.value);if(name==="selected"&&value==="")value="selected";realTag.setAttribute(name,value)}}while(fakeTag.firstChild)realTag.appendChild(fakeTag.firstChild);fakeTag.parentNode.replaceChild(realTag,fakeTag)})}while(container.firstChild)frag.appendChild(container.firstChild)}return frag};DomUtils.fragmentToHtml=function(frag){frag=frag.cloneNode(true);return DomUtils.fragmentToContainer(frag).innerHTML};DomUtils.fragmentToContainer=function(frag){var doc=document;var firstElement=frag.firstChild;while(firstElement&&firstElement.nodeType!==1){firstElement=firstElement.nextSibling}var container=doc.createElement("div");if(!firstElement){container.appendChild(frag)}else{var firstTag=firstElement.nodeName;var wrapData=wrapMap[firstTag]||wrapMap._default;container.innerHTML=wrapData[1]+wrapData[2];var unwraps=wrapData[0];while(unwraps--){container=container.lastChild}container.appendChild(frag)}return container};DomUtils.elementContains=function(a,b){if(a.nodeType!==1)return false;if(a===b)return false;if(a.compareDocumentPosition){return a.compareDocumentPosition(b)&16}else{b=b.parentNode;if(!(b&&b.nodeType===1))return false;if(a===b)return true;return a.contains(b)}};DomUtils.findAll=function(contextNode,selector){if(contextNode.nodeType===11){var frag=contextNode;var container=DomUtils.fragmentToContainer(frag);var results=findAllBySelector(selector,container);while(container.firstChild)frag.appendChild(container.firstChild);return results}return findAllBySelector(selector,contextNode)};DomUtils.find=function(contextNode,selector){var results=DomUtils.findAll(contextNode,selector);return results.length?results[0]:null};var isElementInClipRange=function(elem,clipStart,clipEnd){if(DomUtils.elementContains(elem,clipStart))return false;return DomUtils.compareElementIndex(clipStart,elem)<=0&&DomUtils.compareElementIndex(elem,clipEnd)<=0};DomUtils.findAllClipped=function(contextNode,selector,clipStart,clipEnd){while(clipStart!==clipEnd&&clipStart.nodeType!==1)clipStart=clipStart.nextSibling;while(clipStart!==clipEnd&&clipEnd.nodeType!==1)clipEnd=clipEnd.previousSibling;if(clipStart.nodeType!==1)return[];var resultsPlus=DomUtils.findAll(contextNode,selector);return _.reject(resultsPlus,function(n){return!isElementInClipRange(n,clipStart,clipEnd)})};DomUtils.findClipped=function(contextNode,selector,clipStart,clipEnd){var results=DomUtils.findAllClipped(contextNode,selector,clipStart,clipEnd);return results.length?results[0]:null};var withElementId=function(element,magicId,func){var didSetId=false;if(!element.getAttribute("id")){element.setAttribute("id",magicId);didSetId=true}try{var escapedNodeId=element.getAttribute("id").replace(/'/g,"\\$&");return func("[id='"+escapedNodeId+"']")}finally{if(didSetId)element.removeAttribute("id")}};var matchesSelectorMaybeClipped=function(element,contextNode,selector,clipStart,clipEnd){var selecs=selector.split(",");for(var i=0,N=selecs.length;i<N;i++){var matches=withElementId(element,"DomUtils_matchesSelector_target",function(idSelector){var trimmedSelector=selector.match(/\S.*?(?=\s*$)/)[0];var doctoredSelector=trimmedSelector+idSelector;var result;if(clipStart)result=DomUtils.findClipped(contextNode,doctoredSelector,clipStart,clipEnd);else result=DomUtils.find(contextNode,doctoredSelector);return result===element});if(matches)return true}return false};DomUtils.matchesSelector=function(element,contextNode,selector){return matchesSelectorMaybeClipped(element,contextNode,selector)};DomUtils.matchesSelectorClipped=function(element,contextNode,selector,clipStart,clipEnd){return matchesSelectorMaybeClipped(element,contextNode,selector,clipStart,clipEnd)};DomUtils.compareElementIndex=function(a,b){if(a===b)return 0;if(a.compareDocumentPosition){var n=a.compareDocumentPosition(b);return n&24?0:n&4?-1:1}else{if(a.contains(b)||b.contains(a))return 0;return a.sourceIndex<b.sourceIndex?-1:1}};DomUtils.wrapFragmentForContainer=function(frag,container){if(container&&container.nodeName==="TABLE"&&_.any(frag.childNodes,function(n){return n.nodeName==="TR"})){var tbody=document.createElement("TBODY");tbody.appendChild(frag);frag.appendChild(tbody)}};DomUtils.isInDocument=function(node){if(node===document)return true;if(node.nodeType!==1)node=node.parentNode;if(!(node&&node.nodeType===1))return false;if(node===document.body)return true;return DomUtils.elementContains(document.body,node)};DomUtils.rangeToHtml=function(firstNode,lastNode){var frag=document.createDocumentFragment();for(var n=firstNode,after=lastNode.nextSibling;n&&n!==after;n=n.nextSibling)frag.appendChild(n.cloneNode(true));return DomUtils.fragmentToHtml(frag)};DomUtils.outerHtml=function(node){return DomUtils.rangeToHtml(node,node)};DomUtils.setElementValue=function(node,value){node.value=value;if(node.value===value||node.nodeName!=="SELECT")return;var options=DomUtils.findAll(node,"option");for(var i=0;i<options.length;++i){if(DomUtils.getElementValue(options[i])===value){options[i].selected=true;return}}};DomUtils.getElementValue=function(node){if(!quirks.selectValueMustBeFromAttribute)return node.value;if(node.nodeName==="OPTION"){var val=node.attributes.value;return!val||val.specified?node.value:node.text}else if(node.nodeName==="SELECT"){if(node.selectedIndex<0)return null;return DomUtils.getElementValue(node.options[node.selectedIndex])}else{return node.value}}})();(function(){var element=function(key,value,next,prev){return{key:key,value:value,next:next,prev:prev}};OrderedDict=function(){var self=this;self._dict={};self._first=null;self._last=null;self._size=0;var args=_.toArray(arguments);self._stringify=function(x){return x};if(typeof args[0]==="function")self._stringify=args.shift();_.each(args,function(kv){self.putBefore(kv[0],kv[1],null)})};_.extend(OrderedDict.prototype,{_k:function(key){return" "+this._stringify(key)},empty:function(){var self=this;return!self._first},size:function(){var self=this;return self._size},_linkEltIn:function(elt){var self=this;if(!elt.next){elt.prev=self._last;if(self._last)self._last.next=elt;self._last=elt}else{elt.prev=elt.next.prev;elt.next.prev=elt;if(elt.prev)elt.prev.next=elt}if(self._first===null||self._first===elt.next)self._first=elt},_linkEltOut:function(elt){var self=this;if(elt.next)elt.next.prev=elt.prev;if(elt.prev)elt.prev.next=elt.next;if(elt===self._last)self._last=elt.prev;if(elt===self._first)self._first=elt.next},putBefore:function(key,item,before){var self=this;if(self._dict[self._k(key)])throw new Error("Item "+key+" already present in OrderedDict");var elt=before?element(key,item,self._dict[self._k(before)]):element(key,item,null);if(elt.next===undefined)throw new Error("could not find item to put this one before");self._linkEltIn(elt);self._dict[self._k(key)]=elt;self._size++},append:function(key,item){var self=this;self.putBefore(key,item,null)},remove:function(key){var self=this;var elt=self._dict[self._k(key)];if(elt===undefined)throw new Error("Item "+key+" not present in OrderedDict");self._linkEltOut(elt);self._size--;delete self._dict[self._k(key)];return elt.value},get:function(key){var self=this;if(self.has(key))return self._dict[self._k(key)].value;return undefined},has:function(key){var self=this;return _.has(self._dict,self._k(key))},forEach:function(iter){var self=this;var i=0;var elt=self._first;while(elt!==null){var b=iter(elt.value,elt.key,i);if(b===OrderedDict.BREAK)return;elt=elt.next;i++}},first:function(){var self=this;if(self.empty())return undefined;return self._first.key},firstValue:function(){var self=this;if(self.empty())return undefined;return self._first.value},last:function(){var self=this;if(self.empty())return undefined;return self._last.key},lastValue:function(){var self=this;if(self.empty())return undefined;return self._last.value},prev:function(key){var self=this;if(self.has(key)){var elt=self.get(key);if(elt.prev)return elt.prev.key}return null},next:function(key){var self=this;if(self.has(key)){var elt=self.get(key);if(elt.next)return elt.next.key}return null},moveBefore:function(key,before){var self=this;var elt=self._dict[self._k(key)];var eltBefore=before?self._dict[self._k(before)]:null;if(elt===undefined)throw new Error("Item to move is not present");if(eltBefore===undefined){throw new Error("Could not find element to move this one before")}if(eltBefore===elt.next)return;self._linkEltOut(elt);elt.next=eltBefore;self._linkEltIn(elt)},indexOf:function(key){var self=this;var ret=null;self.forEach(function(v,k,i){if(self._k(k)===self._k(key)){ret=i;return OrderedDict.BREAK}return undefined});return ret},_checkRep:function(){var self=this;_.each(self._dict,function(k,v){if(v.next===v)throw new Error("Next is a loop");if(v.prev===v)throw new Error("Prev is a loop")})}});OrderedDict.BREAK={"break":true}})();(function(){Spark={};Spark._currentRenderer=function(){var current=null;return{get:function(){return current},withValue:function(v,func){var previous=current;current=v;try{return func()}finally{current=previous}}}}();Spark._TAG="_spark_"+Random.id();Spark._ANNOTATION_NOTIFY="notify";Spark._ANNOTATION_DATA="data";Spark._ANNOTATION_ISOLATE="isolate";Spark._ANNOTATION_EVENTS="events";Spark._ANNOTATION_WATCH="watch";Spark._ANNOTATION_LABEL="label";Spark._ANNOTATION_LANDMARK="landmark";Spark._ANNOTATION_LIST="list";Spark._ANNOTATION_LIST_ITEM="item";Spark._checkIECompliance=false;Spark._globalPreserves={};var makeRange=function(type,start,end,inner){var range=new LiveRange(Spark._TAG,start,end,inner);range.type=type;return range};var findRangeOfType=function(type,node){var range=LiveRange.findRange(Spark._TAG,node);while(range&&range.type!==type)range=range.findParent();return range};var findParentOfType=function(type,range){do{range=range.findParent()}while(range&&range.type!==type);return range};var notifyWatchers=function(start,end){var tempRange=new LiveRange(Spark._TAG,start,end,true);for(var walk=tempRange;walk;walk=walk.findParent())if(walk.type===Spark._ANNOTATION_WATCH)walk.notify();tempRange.destroy()};var eventGuardActive=false;var withEventGuard=function(func){var previous=eventGuardActive;eventGuardActive=true;try{return func()}finally{eventGuardActive=previous}};Spark._Renderer=function(){this.annotations={};this._branchNotes={};this.currentBranch=this.newLabelStack();this.landmarkRanges=[];this.pc=new PreservationController};_.extend(Spark._Renderer.prototype,{annotate:function(html,type,what){if(typeof what!=="function"){var attribs=what;what=function(range){if(range)_.extend(range,attribs)}}var id=(type||"")+":"+Random.id();this.annotations[id]=function(start,end){if(!start||!type){what(null);return}var range=makeRange(type,start,end);what(range)};return"<$"+id+">"+html+"</$"+id+">"},newLabelStack:function(){var stack=[this._branchNotes];return{pushLabel:function(label){var top=stack[stack.length-1];var key="_"+label;stack.push(top[key]=top[key]||{})},popLabel:function(){stack.pop()},getNotes:function(){var top=stack[stack.length-1];return top},mark:function(prop){for(var i=stack.length-1;i>=0&&!stack[i][prop];i--)stack[i][prop]=true}}},materialize:function(htmlFunc){var self=this;var html=Spark._currentRenderer.withValue(self,htmlFunc);html=self.annotate(html);var fragById={};var replaceInclusions=function(container){var n=container.firstChild;while(n){var next=n.nextSibling;if(n.nodeType===8){var frag=fragById[n.nodeValue];if(frag===false){throw new Error("Spark HTML fragments may only be used once. "+"Second use in "+DomUtils.fragmentToHtml(container))}else if(frag){fragById[n.nodeValue]=false;DomUtils.wrapFragmentForContainer(frag,n.parentNode);n.parentNode.replaceChild(frag,n)}}else if(n.nodeType===1){replaceInclusions(n)}n=next}};var bufferStack=[[]];var idStack=[];var ret;var regex=/<(\/?)\$([^<>]+)>|<|[^<]+/g;regex.lastIndex=0;var parts;while(parts=regex.exec(html)){var isOpen=!parts[1];var id=parts[2];var annotationFunc=self.annotations[id];if(annotationFunc===false){throw new Error("Spark HTML fragments may be used only once. "+"Second use of: "+DomUtils.fragmentToHtml(fragById[id]))}else if(!annotationFunc){bufferStack[bufferStack.length-1].push(parts[0])}else if(isOpen){idStack.push(id);bufferStack.push([])}else{var idOnStack=idStack.pop();if(idOnStack!==id)throw new Error("Range mismatch: "+idOnStack+" / "+id);var frag=DomUtils.htmlToFragment(bufferStack.pop().join(""));replaceInclusions(frag);if(!frag.firstChild)frag.appendChild(document.createComment("empty"));annotationFunc(frag.firstChild,frag.lastChild);self.annotations[id]=false;if(!idStack.length){ret=frag;break}fragById[id]=frag;bufferStack[bufferStack.length-1].push("<!--"+id+"-->")}}scheduleOnscreenSetup(ret,self.landmarkRanges);self.landmarkRanges=[];_.each(self.annotations,function(annotationFunc){if(annotationFunc)annotationFunc()});self.annotations={};_.each(DomUtils.findAll(ret,"[value], textarea, select"),function(node){node._sparkOriginalRenderedValue=[DomUtils.getElementValue(node)]});_.each(DomUtils.findAll(ret,"input[type=checkbox], input[type=radio]"),function(node){node._sparkOriginalRenderedChecked=[!!node.checked]});return ret}});var withRenderer=function(f){return function(){var renderer=Spark._currentRenderer.get();var args=_.toArray(arguments);if(!renderer)return args.pop();args.push(renderer);return f.apply(null,args)}};var scheduleOnscreenSetup=function(frag,landmarkRanges){var renderedRange=new LiveRange(Spark._TAG,frag);var finalized=false;renderedRange.finalize=function(){finalized=true};Meteor._atFlush(function(){if(finalized)return;if(!DomUtils.isInDocument(renderedRange.firstNode())){var node=renderedRange.firstNode();while(node.parentNode)node=node.parentNode;if(node["_protect"]){}else{Spark.finalize(node);return}}_.each(landmarkRanges,function(landmarkRange){if(!landmarkRange.isPreservedConstant)landmarkRange.rendered.call(landmarkRange.landmark)});var walk=renderedRange;while(walk=findParentOfType(Spark._ANNOTATION_LANDMARK,walk))walk.rendered.call(walk.landmark);notifyWatchers(renderedRange.firstNode(),renderedRange.lastNode());renderedRange.destroy()})};Spark.render=function(htmlFunc){var renderer=new Spark._Renderer;var frag=renderer.materialize(htmlFunc);return frag};var PreservationController=function(){this.roots=[];this.regionPreservations=[]};_.extend(PreservationController.prototype,{addRoot:function(preserve,fromRange,toRange,optContextNode){var self=this;self.roots.push({context:optContextNode,preserve:preserve,fromRange:fromRange,toRange:toRange})},addConstantRegion:function(from,to){var self=this;self.regionPreservations.push({type:"region",fromStart:from.firstNode(),fromEnd:from.lastNode(),newRange:to})},computePreservations:function(existingRange,newRange){var self=this;var preservations=_.clone(self.regionPreservations);var visitLabeledNodes=function(context,clipRange,nodeLabeler,selector,func){context=context||clipRange.containerNode();var nodes=DomUtils.findAllClipped(context,selector,clipRange.firstNode(),clipRange.lastNode());_.each(nodes,function(n){var label=nodeLabeler(n);label&&func(n,label)})};_.each(self.roots,function(root){root.fromNodesByLabel={};_.each(root.preserve,function(nodeLabeler,selector){root.fromNodesByLabel[selector]={};visitLabeledNodes(root.context,root.fromRange,nodeLabeler,selector,function(n,label){root.fromNodesByLabel[selector][label]=n})})});var tempRange=new LiveRange(Spark._TAG,newRange.firstNode(),newRange.lastNode());var commentFrag=document.createDocumentFragment();commentFrag.appendChild(document.createComment(""));var newRangeFrag=tempRange.replaceContents(commentFrag);var wrapperRange=new LiveRange(Spark._TAG,newRangeFrag);existingRange.insertBefore(newRangeFrag);_.each(self.roots,function(root){_.each(root.preserve,function(nodeLabeler,selector){visitLabeledNodes(root.context,root.toRange,nodeLabeler,selector,function(n,label){var match=root.fromNodesByLabel[selector][label];if(match){preservations.push({type:"node",from:match,to:n});root.fromNodesByLabel[selector][label]=null}})})});var extractedFrag=wrapperRange.extract();wrapperRange.destroy();tempRange.replaceContents(extractedFrag);tempRange.destroy();return preservations}});var pathForRange=function(r){var path=[],r;while(r=findParentOfType(Spark._ANNOTATION_LABEL,r))path.unshift(r.label);return path.join(" :: ")};Spark.renderToRange=function(range,htmlFunc){var startNode=range.firstNode();if(!startNode||!startNode.parentNode)return;var renderer=new Spark._Renderer;var visitLandmarksInRange=function(range,func){var stack=renderer.newLabelStack();range.visit(function(isStart,r){if(r.type===Spark._ANNOTATION_LABEL){if(isStart)stack.pushLabel(r.label);else stack.popLabel()}else if(r.type===Spark._ANNOTATION_LANDMARK&&isStart){func(r,stack.getNotes())}})};visitLandmarksInRange(range,function(landmarkRange,notes){notes.originalRange=landmarkRange});var radios=DomUtils.findAllClipped(range.containerNode(),"input[type=radio]",range.firstNode(),range.lastNode());_.each(radios,function(node){node._currentChecked=[!!node.checked]});var frag=renderer.materialize(htmlFunc);DomUtils.wrapFragmentForContainer(frag,range.containerNode());var tempRange=new LiveRange(Spark._TAG,frag);var pc=renderer.pc;visitLandmarksInRange(tempRange,function(landmarkRange,notes){if(notes.originalRange){if(landmarkRange.constant)pc.addConstantRegion(notes.originalRange,landmarkRange);pc.addRoot(landmarkRange.preserve,notes.originalRange,landmarkRange)}});var walk=range;while(walk=walk.findParent()){if(!walk.firstNode().parentNode)break;if(walk.type===Spark._ANNOTATION_LANDMARK,walk)pc.addRoot(walk.preserve,range,tempRange,walk.containerNode())}pc.addRoot(Spark._globalPreserves,range,tempRange);var preservations=pc.computePreservations(range,tempRange);tempRange.destroy();var results={};withEventGuard(function(){range.operate(function(start,end){Spark.finalize(start,end);Spark._patch(start.parentNode,frag,start.previousSibling,end.nextSibling,preservations,results)})});_.each(results.regionPreservations,function(landmarkRange){landmarkRange.isPreservedConstant=true})};Spark.finalize=function(start,end){if(!start.parentNode&&start.nodeType!==11){var frag=document.createDocumentFragment();frag.appendChild(start);start=frag;end=null}var wrapper=new LiveRange(Spark._TAG,start,end);wrapper.visit(function(isStart,range){isStart&&range.finalize&&range.finalize()});wrapper.destroy(true)};Spark.setDataContext=withRenderer(function(dataContext,html,_renderer){return _renderer.annotate(html,Spark._ANNOTATION_DATA,{data:dataContext})});Spark.getDataContext=function(node){var range=findRangeOfType(Spark._ANNOTATION_DATA,node);return range&&range.data};var universalListener=null;var getListener=function(){if(!universalListener)universalListener=new UniversalEventListener(function(event){if(eventGuardActive)return;
var ranges=[];var walk=findRangeOfType(Spark._ANNOTATION_EVENTS,event.currentTarget);while(walk){ranges.push(walk);walk=findParentOfType(Spark._ANNOTATION_EVENTS,walk)}_.each(ranges,function(r){r.handler(event)})},Spark._checkIECompliance);return universalListener};Spark.attachEvents=withRenderer(function(eventMap,html,_renderer){var listener=getListener();var handlerMap={};_.each(eventMap,function(callback,spec){var clauses=spec.split(/,\s+/);_.each(clauses,function(clause){var parts=clause.split(/\s+/);if(parts.length===0)return;var type=parts.shift();var selector=parts.join(" ");handlerMap[type]=handlerMap[type]||[];handlerMap[type].push({selector:selector,callback:callback})})});var eventTypes=_.keys(handlerMap);var installHandlers=function(range){_.each(eventTypes,function(t){for(var n=range.firstNode(),after=range.lastNode().nextSibling;n&&n!==after;n=n.nextSibling)listener.installHandler(n,t)})};html=_renderer.annotate(html,Spark._ANNOTATION_WATCH,{notify:function(){installHandlers(this)}});var finalized=false;html=_renderer.annotate(html,Spark._ANNOTATION_EVENTS,function(range){if(!range)return;_.each(eventTypes,function(t){listener.addType(t)});installHandlers(range);range.finalize=function(){finalized=true};range.handler=function(event){var handlers=handlerMap[event.type]||[];for(var i=0;i<handlers.length;i++){if(finalized||event.isImmediatePropagationStopped())return;var handler=handlers[i];var callback=handler.callback;var selector=handler.selector;if(selector){if(!DomUtils.matchesSelectorClipped(event.currentTarget,range.containerNode(),selector,range.firstNode(),range.lastNode())){continue}}else{if(event.currentTarget!==event.target)continue}var eventData=Spark.getDataContext(event.currentTarget);var landmarkRange=findParentOfType(Spark._ANNOTATION_LANDMARK,range);var landmark=landmarkRange&&landmarkRange.landmark;var returnValue=callback.call(eventData,event,landmark);if(returnValue===false){event.stopImmediatePropagation();event.preventDefault()}}}});return html});Spark.isolate=function(htmlFunc){var renderer=Spark._currentRenderer.get();if(!renderer)return htmlFunc();var range;var firstRun=true;var retHtml;Meteor.autorun(function(handle){if(firstRun){retHtml=renderer.annotate(htmlFunc(),Spark._ANNOTATION_ISOLATE,function(r){if(!r){handle.stop()}else{range=r;range.finalize=function(){handle.stop()}}});firstRun=false}else{Spark.renderToRange(range,htmlFunc)}});return retHtml};var applyChanges=function(doc,changeFields){_.each(changeFields,function(value,key){if(value===undefined)delete doc[key];else doc[key]=value})};var idStringify;var idParse;if(typeof LocalCollection!=="undefined"){idStringify=function(id){if(id===null)return id;else return LocalCollection._idStringify(id)}}else{idStringify=function(id){return id}}Spark.list=function(cursor,itemFunc,elseFunc){elseFunc=elseFunc||function(){return""};var callbacks={};var observerCallbacks={};_.each(["addedBefore","removed","movedBefore","changed"],function(name){observerCallbacks[name]=function(){return callbacks[name].apply(null,arguments)}});var itemDict=new OrderedDict(idStringify);_.extend(callbacks,{addedBefore:function(id,item,before){var doc=EJSON.clone(item);doc._id=id;var elt={doc:doc,liveRange:null};itemDict.putBefore(id,elt,before)}});var handle=cursor.observeChanges(observerCallbacks);var renderer=Spark._currentRenderer.get();var maybeAnnotate=renderer?_.bind(renderer.annotate,renderer):function(html){return html};var html="";var outerRange;if(itemDict.empty())html=elseFunc();else{itemDict.forEach(function(elt){html+=maybeAnnotate(itemFunc(elt.doc),Spark._ANNOTATION_LIST_ITEM,function(range){elt.liveRange=range})})}var stopped=false;var cleanup=function(){handle.stop();stopped=true};html=maybeAnnotate(html,Spark._ANNOTATION_LIST,function(range){if(!range){cleanup()}else{outerRange=range;outerRange.finalize=cleanup}});if(!renderer)cleanup();var notifyParentsRendered=function(){var walk=outerRange;while(walk=findParentOfType(Spark._ANNOTATION_LANDMARK,walk))walk.rendered.call(walk.landmark)};var later=function(f){Meteor._atFlush(function(){if(!stopped)withEventGuard(f)})};_.extend(callbacks,{addedBefore:function(id,fields,before){later(function(){var doc=EJSON.clone(fields);doc._id=id;var frag=Spark.render(_.bind(itemFunc,null,doc));DomUtils.wrapFragmentForContainer(frag,outerRange.containerNode());var range=makeRange(Spark._ANNOTATION_LIST_ITEM,frag);if(itemDict.empty()){Spark.finalize(outerRange.replaceContents(frag))}else if(before===null){itemDict.lastValue().liveRange.insertAfter(frag)}else{itemDict.get(before).liveRange.insertBefore(frag)}itemDict.putBefore(id,{doc:doc,liveRange:range},before)})},removed:function(id){later(function(){if(itemDict.first()===itemDict.last()){var frag=Spark.render(elseFunc);DomUtils.wrapFragmentForContainer(frag,outerRange.containerNode());Spark.finalize(outerRange.replaceContents(frag))}else Spark.finalize(itemDict.get(id).liveRange.extract());itemDict.remove(id);notifyParentsRendered()})},movedBefore:function(id,before){later(function(){var frag=itemDict.get(id).liveRange.extract();if(before===null){itemDict.lastValue().liveRange.insertAfter(frag)}else{itemDict.get(before).liveRange.insertBefore(frag)}itemDict.moveBefore(id,before);notifyParentsRendered()})},changed:function(id,fields){later(function(){var elt=itemDict.get(id);if(!elt)throw new Error("Unknown id for changed: "+id);applyChanges(elt.doc,fields);Spark.renderToRange(elt.liveRange,_.bind(itemFunc,null,elt.doc))})}});return html};var nextLandmarkId=1;Spark.Landmark=function(){this.id=nextLandmarkId++;this._range=null};_.extend(Spark.Landmark.prototype,{firstNode:function(){return this._range.firstNode()},lastNode:function(){return this._range.lastNode()},find:function(selector){var r=this._range;return DomUtils.findClipped(r.containerNode(),selector,r.firstNode(),r.lastNode())},findAll:function(selector){var r=this._range;return DomUtils.findAllClipped(r.containerNode(),selector,r.firstNode(),r.lastNode())},hasDom:function(){return!!this._range}});Spark.UNIQUE_LABEL=["UNIQUE_LABEL"];Spark.labelBranch=function(label,htmlFunc){var renderer=Spark._currentRenderer.get();if(!renderer||label===null)return htmlFunc();if(label===Spark.UNIQUE_LABEL)label=Random.id();renderer.currentBranch.pushLabel(label);var html=htmlFunc();var occupied=renderer.currentBranch.getNotes().occupied;renderer.currentBranch.popLabel();if(!occupied)return html;return renderer.annotate(html,Spark._ANNOTATION_LABEL,{label:label})};Spark.createLandmark=function(options,htmlFunc){var renderer=Spark._currentRenderer.get();if(!renderer){var landmark=new Spark.Landmark;options.created&&options.created.call(landmark);var html=htmlFunc(landmark);options.destroyed&&options.destroyed.call(landmark);return html}var preserve={};if(_.isArray(options.preserve))_.each(options.preserve,function(selector){preserve[selector]=true});else preserve=options.preserve||{};for(var selector in preserve)if(typeof preserve[selector]!=="function")preserve[selector]=function(){return true};renderer.currentBranch.mark("occupied");var notes=renderer.currentBranch.getNotes();var landmark;if(notes.originalRange){if(notes.originalRange.superceded)throw new Error("Can't create second landmark in same branch");notes.originalRange.superceded=true;landmark=notes.originalRange.landmark}else{landmark=new Spark.Landmark;if(options.created){var oldCx=Meteor.deps.Context.current;Meteor.deps.Context.current=null;try{options.created.call(landmark)}finally{Meteor.deps.Context.current=oldCx}}}notes.landmark=landmark;var html=htmlFunc(landmark);return renderer.annotate(html,Spark._ANNOTATION_LANDMARK,function(range){if(!range){options.destroyed&&options.destroyed.call(landmark);return}_.extend(range,{preserve:preserve,constant:!!options.constant,rendered:options.rendered||function(){},destroyed:options.destroyed||function(){},landmark:landmark,finalize:function(){if(!this.superceded){this.landmark._range=null;this.destroyed.call(this.landmark)}}});landmark._range=range;renderer.landmarkRanges.push(range)})};Spark._getEnclosingLandmark=function(node){var range=findRangeOfType(Spark._ANNOTATION_LANDMARK,node);return range?range.landmark:null}})();Spark._patch=function(tgtParent,srcParent,tgtBefore,tgtAfter,preservations,results){var copyFunc=function(t,s){LiveRange.transplantTag(Spark._TAG,t,s)};var patcher=new Spark._Patcher(tgtParent,srcParent,tgtBefore,tgtAfter);var visitNodes=function(parent,before,after,func){for(var n=before?before.nextSibling:parent.firstChild;n&&n!==after;n=n.nextSibling){if(func(n)!==false&&n.firstChild)visitNodes(n,null,null,func)}};results=results||{};var regionPreservations=results.regionPreservations=results.regionPreservations||[];var lastTgtMatch=null;visitNodes(srcParent,null,null,function(src){var pres=_.find(preservations,function(p){return p.type==="region"&&p.newRange.firstNode()===src})||_.find(preservations,function(p){return p.type==="node"&&p.to===src});if(pres){var tgt=pres.type==="region"?pres.fromStart:pres.from;if(!lastTgtMatch||DomUtils.compareElementIndex(lastTgtMatch,tgt)<0){if(pres.type==="region"){if(patcher.match(pres.fromStart,pres.newRange.firstNode(),copyFunc,true)){patcher.skipToSiblings(pres.fromEnd,pres.newRange.lastNode());LiveRange.transplantRange(pres.fromStart,pres.fromEnd,pres.newRange);regionPreservations.push(pres.newRange)}}else if(pres.type==="node"){if(patcher.match(tgt,src,copyFunc)){lastTgtMatch=tgt;if(tgt.firstChild||src.firstChild){if(tgt.nodeName!=="TEXTAREA"&&tgt.nodeName!=="SELECT"){Spark._patch(tgt,src,null,null,preservations)}}return false}}}}return true});patcher.finish();return results};Spark._Patcher=function(tgtParent,srcParent,tgtBefore,tgtAfter){this.tgtParent=tgtParent;this.srcParent=srcParent;this.tgtBefore=tgtBefore;this.tgtAfter=tgtAfter;this.lastKeptTgtNode=null;this.lastKeptSrcNode=null};Spark._Patcher.prototype.match=function(tgtNode,srcNode,copyCallback,onlyAdvance){var lastKeptTgt=this.lastKeptTgtNode;var lastKeptSrc=this.lastKeptSrcNode;var tgt=tgtNode;var src=srcNode;if(!tgt!=!src){return false}var starting=!lastKeptTgt;var finishing=!tgt;if(!starting){while(lastKeptTgt.parentNode!==this.tgtParent&&!(tgt&&DomUtils.elementContains(lastKeptTgt.parentNode,tgt))){this._replaceNodes(lastKeptTgt,null,lastKeptSrc,null);lastKeptTgt=lastKeptTgt.parentNode;lastKeptSrc=lastKeptSrc.parentNode}this.lastKeptTgtNode=lastKeptTgt;this.lastKeptSrcNode=lastKeptSrc;if(!finishing&&(DomUtils.elementContains(lastKeptSrc,src)||!(lastKeptSrc.parentNode===this.srcParent||DomUtils.elementContains(lastKeptSrc.parentNode,src)))){return false}}if(finishing){this._replaceNodes(lastKeptTgt,null,lastKeptSrc,null,this.tgtParent,this.srcParent)}else{if(!onlyAdvance){if(tgt.nodeName!==src.nodeName)return false}for(var a=tgt.parentNode,b=src.parentNode;a!==(starting?this.tgtParent:lastKeptTgt.parentNode);a=a.parentNode,b=b.parentNode){if(b===(starting?this.srcParent:lastKeptSrc.parentNode))return false;if(a.nodeName!==b.nodeName)return false}if(b!==(starting?this.srcParent:lastKeptSrc.parentNode)){return false}var firstIter=true;while(true){if(!(firstIter&&onlyAdvance)){if(tgt.nodeType===1)Spark._Patcher._copyAttributes(tgt,src);if(copyCallback)copyCallback(tgt,src)}firstIter=false;if((starting?this.tgtParent:lastKeptTgt.parentNode)===tgt.parentNode){this._replaceNodes(lastKeptTgt,tgt,lastKeptSrc,src);break}else{this._replaceNodes(null,tgt,null,src);tgt=tgt.parentNode;src=src.parentNode}}}this.lastKeptTgtNode=tgtNode;this.lastKeptSrcNode=srcNode;return true};Spark._Patcher.prototype.skipToSiblings=function(tgt,src){var lastTgt=this.lastKeptTgtNode;var lastSrc=this.lastKeptSrcNode;if(!(lastTgt&&lastTgt.parentNode===tgt.parentNode))return false;if(!(lastSrc&&lastSrc.parentNode===src.parentNode))return false;this.lastKeptTgtNode=tgt;this.lastKeptSrcNode=src;return true};Spark._Patcher.prototype.finish=function(){return this.match(null,null)};Spark._Patcher.prototype._replaceNodes=function(tgtBefore,tgtAfter,srcBefore,srcAfter,optTgtParent,optSrcParent){var tgtParent=optTgtParent||(tgtBefore||tgtAfter).parentNode;var srcParent=optSrcParent||(srcBefore||srcAfter).parentNode;if(tgtParent===this.tgtParent){tgtBefore=tgtBefore||this.tgtBefore;tgtAfter=tgtAfter||this.tgtAfter}if(srcParent===this.srcParent){srcBefore=srcBefore||this.srcBefore;srcAfter=srcAfter||this.srcAfter}var n;while((n=tgtBefore?tgtBefore.nextSibling:tgtParent.firstChild)&&n!==tgtAfter){tgtParent.removeChild(n)}var m;while((m=srcBefore?srcBefore.nextSibling:srcParent.firstChild)&&m!==srcAfter){tgtParent.insertBefore(m,tgtAfter||null)}};Spark._Patcher._copyAttributes=function(tgt,src){var srcAttrs=src.attributes;var tgtAttrs=tgt.attributes;var targetFocused=tgt===document.activeElement;if(tgt.style.cssText)tgt.style.cssText="";var isRadio=false;var finalChecked=null;if(tgt.nodeName==="INPUT"){isRadio=tgt.type==="radio";if(isRadio||tgt.type==="checkbox"){var tgtOriginalChecked=!!tgt._sparkOriginalRenderedChecked&&tgt._sparkOriginalRenderedChecked[0];var srcOriginalChecked=!!src._sparkOriginalRenderedChecked&&src._sparkOriginalRenderedChecked[0];var tgtCurrentChecked=tgt._currentChecked?tgt._currentChecked[0]:tgt.checked;if(tgtOriginalChecked===srcOriginalChecked){finalChecked=tgtCurrentChecked}else{finalChecked=srcOriginalChecked;tgt._sparkOriginalRenderedChecked=[finalChecked]}}}for(var i=tgtAttrs.length-1;i>=0;i--){var attr=tgtAttrs[i];if(!attr.specified)continue;var name=attr.name;if(!tgtAttrs[name])continue;if(name==="id"||name==="type")continue;if(isRadio&&name==="name")continue;if(name==="value")continue;if(name==="src")continue;var possibleExpando=tgt[name];if(possibleExpando&&(typeof possibleExpando==="object"||/^jQuery/.test(name)))continue;tgt.removeAttributeNode(attr)}if(tgt.mergeAttributes){var srcExpando=src._sparkOriginalRenderedValue;src.removeAttribute("_sparkOriginalRenderedValue");tgt.mergeAttributes(src);if(srcExpando)src._sparkOriginalRenderedValue=srcExpando;if(src.name)tgt.name=src.name}else{for(var i=0,L=srcAttrs.length;i<L;i++){var srcA=srcAttrs.item(i);if(srcA.specified){var name=srcA.name.toLowerCase();var value=String(srcA.value);if(name==="type"){}else if(name==="checked"){}else if(name==="style"){tgt.style.cssText=src.style.cssText}else if(name==="class"){tgt.className=src.className}else if(name==="value"){}else if(name==="src"){if(src.src!==tgt.src)tgt.src=src.src}else{try{tgt.setAttribute(name,value)}catch(e){throw new Error("Error copying attribute '"+name+"': "+e)}}}}}var originalRenderedValue=function(node){if(!node._sparkOriginalRenderedValue)return null;return node._sparkOriginalRenderedValue[0]};var srcOriginalRenderedValue=originalRenderedValue(src);var tgtOriginalRenderedValue=originalRenderedValue(tgt);var tgtCurrentValue=DomUtils.getElementValue(tgt);if(tgt.nodeName==="SELECT"){while(tgt.firstChild)tgt.removeChild(tgt.firstChild);while(src.firstChild)tgt.insertBefore(src.firstChild,null);DomUtils.setElementValue(tgt,tgtCurrentValue)}if(srcOriginalRenderedValue!==tgtOriginalRenderedValue&&(tgtCurrentValue===srcOriginalRenderedValue||!targetFocused)){if(tgtCurrentValue!==srcOriginalRenderedValue)DomUtils.setElementValue(tgt,srcOriginalRenderedValue);tgt._sparkOriginalRenderedValue=[srcOriginalRenderedValue]}if(finalChecked!==null){if(tgt.checked!==finalChecked)tgt.checked=finalChecked;tgt.defaultChecked=finalChecked;if(finalChecked)tgt.setAttribute("checked","checked");else tgt.removeAttribute("checked")}};
